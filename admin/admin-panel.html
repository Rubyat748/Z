<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZTA â€“ Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<style>
    body { margin:0; background:#000; color:#fff; font-family:Arial; }
    .navbar { width:100%; padding:20px 40px; display:flex; justify-content:space-between; align-items:center; background:#000; border-bottom:1px solid #111; position:sticky; top:0; z-index:50; }
    .nav-left { font-size:26px; letter-spacing:3px; font-weight:700; color:#9acd32; }
    .section-title { font-size:30px; font-weight:700; margin-top:40px; text-align:center; color:#9acd32; }
    .admin-card { background:#0b0b0b; border:1px solid #111; padding:20px; border-radius:10px; transition:0.3s; }
    .admin-card:hover { border-color:#444; transform:translateY(-4px); }
    .user-box { background:#0a0a0a; border:1px solid #111; padding:15px; border-radius:10px; margin-bottom:12px; transition:0.25s; }
    .user-box:hover { border-color:#333; transform:translateY(-3px); }
    .btn { padding:8px 14px; border-radius:6px; border:1px solid #9acd32; color:#9acd32; background:none; cursor:pointer; transition:0.25s; }
    .btn:hover { background:#9acd32; color:#000; }
    .logout-btn { color:#f33; border-color:#f33; }
    .logout-btn:hover { background:#f33; color:#000; }
</style>
</head>
<body>

<div class="navbar">
    <div class="nav-left">ZTA ADMIN</div>
    <div><a class="logout-btn btn" href="#" onclick="logoutAdmin()">Logout</a></div>
</div>

<h2 class="section-title">User Management</h2>

<div class="max-w-4xl mx-auto mt-6 flex gap-3 p-4">
    <input id="searchUser" class="w-full bg-transparent border border-gray-700 p-3 rounded text-green-300" placeholder="Search by username, email or UID">
    <button class="btn" onclick="loadUsers()">FIND</button>
</div>

<div class="max-w-5xl mx-auto mt-10 grid grid-cols-1 md:grid-cols-3 gap-8 p-4">
    <div class="admin-card">
        <h3 class="text-lg font-bold mb-3 text-green-300">ðŸŸ¢ ONLINE USERS</h3>
        <div id="onlineUsers">Loading...</div>
    </div>

    <div class="admin-card">
        <h3 class="text-lg font-bold mb-3 text-green-300">ðŸ‘¤ ALL USERS</h3>
        <div id="userList">Loading...</div>
    </div>

    <div class="admin-card">
        <h3 class="text-lg font-bold mb-3 text-green-300">ðŸ”´ OFFLINE USERS</h3>
        <div id="offlineUsers">Loading...</div>
    </div>
</div>

<!-- Firebase SDK v9+ (modular) â€“ matches your firebase.js style -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Your config & helpers -->
<script src="firebase.js"></script>

<script>
// ====================== ADMIN SECURITY ======================
if (!localStorage.getItem("zta_admin_login")) {
    window.location.href = "admin-login.html";
}
function logoutAdmin() {
    localStorage.removeItem("zta_admin_login");
    window.location.href = "admin-login.html";
}

// ====================== ALL USERS (with search) ======================
async function loadUsers() {
    const search = document.getElementById("searchUser").value.trim().toLowerCase();
    const list = document.getElementById("userList");
    list.innerHTML = "<p class='text-gray-500'>Loading...</p>";

    try {
        const snap = await ZTA.db.collection("users").get();
        list.innerHTML = "";

        if (snap.empty) {
            list.innerHTML = "<p class='text-gray-500'>No users found</p>";
            return;
        }

        snap.forEach(doc => {
            const u = doc.data();
            const uid = doc.id;

            const matches = !search ||
                uid.toLowerCase().includes(search) ||
                (u.username && u.username.toLowerCase().includes(search)) ||
                (u.email && u.email.toLowerCase().includes(search));

            if (!matches) return;

            list.innerHTML += `
                <div class="user-box">
                    <p><b>UID:</b> ${uid}</p>
                    <p><b>Username:</b> ${u.username || "N/A"}</p>
                    <p><b>Email:</b> ${u.email}</p>
                    <p><b>Banned:</b> ${u.banned ? "<span style='color:red'>YES</span>" : "<span style='color:lightgreen'>NO</span>"}</p>
                    <div class="flex gap-3 mt-3">
                        <button class="btn" onclick="banUser('${uid}')">BAN</button>
                        <button class="btn" onclick="unbanUser('${uid}')">UNBAN</button>
                    </div>
                </div>
            `;
        });
    } catch (err) {
        list.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
    }
}

// ====================== BAN / UNBAN ======================
async function banUser(uid) {
    if (confirm("Ban this user?")) {
        await ZTA.db.collection("users").doc(uid).update({ banned: true });
        loadUsers();
    }
}
async function unbanUser(uid) {
    if (confirm("Unban this user?")) {
        await ZTA.db.collection("users").doc(uid).update({ banned: false });
        loadUsers();
    }
}

// ====================== REALTIME ONLINE/OFFLINE (optimized) ======================
function startRealtimeStatusListener() {
    const onlineBox = document.getElementById("onlineUsers");
    const offlineBox = document.getElementById("offlineUsers");

    onlineBox.innerHTML = "<p class='text-gray-500'>Listening...</p>";
    offlineBox.innerHTML = "<p class='text-gray-500'>Listening...</p>";

    // Listen only to /status node
    ZTA.rtdb.ref("status").on("value", async (snap) => {
        const statusData = snap.val() || {};

        // Get all users once (we'll reuse this data)
        const usersSnap = await ZTA.db.collection("users").get();

        onlineBox.innerHTML = "";
        offlineBox.innerHTML = "";

        let onlineCount = 0, offlineCount = 0;

        usersSnap.forEach(doc => {
            const uid = doc.id;
            const u = doc.data();
            if (!u.email) return;

            const status = statusData[uid];
            const isOnline = status && status.state === "online";

            const html = `
                <div class="user-box">
                    <p><b>${u.username || "No username"}</b></p>
                    <p class="text-sm">${u.email}</p>
                </div>
            `;

            if (isOnline) {
                onlineBox.innerHTML += html;
                onlineCount++;
            } else if (status) { // has ever been online â†’ show as offline
                offlineBox.innerHTML += html;
                offlineCount++;
            }
            // if no status record at all â†’ ignore (never logged in)
        });

        if (onlineCount === 0) onlineBox.innerHTML = "<p class='text-gray-500'>No one online</p>";
        if (offlineCount === 0) offlineBox.innerHTML = "<p class='text-gray-500'>No offline users with history</p>";
    });
}

// ====================== INIT ======================
loadUsers();
startRealtimeStatusListener();

</script>
</body>
</html>
